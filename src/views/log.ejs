<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Log — TBank Emulator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
      background: #1a1a2e;
      color: #e0e0e0;
      padding: 20px;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid #333;
    }
    .header h1 {
      font-size: 20px;
      color: #ffdd2d;
    }
    .header .info {
      font-size: 13px;
      color: #888;
    }
    .header .info .count { color: #ffdd2d; font-weight: bold; }
    .header .info .dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4caf50;
      margin-right: 4px;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th {
      background: #16213e;
      color: #ffdd2d;
      padding: 10px 8px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    td {
      padding: 8px;
      border-bottom: 1px solid #2a2a4a;
      vertical-align: top;
    }
    tr:hover td { background: #16213e; }
    .status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 11px;
    }
    .status-NEW { background: #1e3a5f; color: #64b5f6; }
    .status-CONFIRMED { background: #1b5e20; color: #81c784; }
    .status-REJECTED { background: #b71c1c; color: #ef9a9a; }
    .status-REFUNDED { background: #e65100; color: #ffcc80; }
    .amount {
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
    }
    .time { color: #888; white-space: nowrap; font-size: 12px; }
    .payload-toggle {
      cursor: pointer;
      color: #64b5f6;
      text-decoration: underline;
      font-size: 12px;
    }
    .payload-toggle:hover { color: #90caf9; }
    .payload-content {
      display: none;
      margin-top: 6px;
      background: #0f0f23;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 8px;
      font-size: 11px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .payload-content.open { display: block; }
    .webhook-entry {
      margin-top: 4px;
      padding: 4px 6px;
      background: #16213e;
      border-radius: 3px;
      font-size: 11px;
    }
    .webhook-entry .wh-status {
      font-weight: 600;
    }
    .wh-ok { color: #81c784; }
    .wh-fail { color: #ef9a9a; }
    .empty {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      font-size: 16px;
    }
    .desc { color: #aaa; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .order-id { color: #ce93d8; font-weight: 600; }
  </style>
</head>
<body>
  <div class="header">
    <h1>T-Bank Emulator — Payment Log</h1>
    <div class="info">
      <span class="dot"></span>
      Auto-refresh 5s | Payments: <span class="count" id="total">0</span>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Time</th>
        <th>Order</th>
        <th>Payment ID</th>
        <th>Amount</th>
        <th>Description</th>
        <th>Status</th>
        <th>Request Payload</th>
        <th>Webhooks</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="8" class="empty">Loading...</td></tr>
    </tbody>
  </table>

  <script>
    function formatTime(iso) {
      if (!iso) return '-';
      const d = new Date(iso);
      return d.toLocaleString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit', day: '2-digit', month: '2-digit' });
    }

    function formatAmount(kopecks) {
      return (kopecks / 100).toFixed(2) + ' RUB';
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function togglePayload(id) {
      const el = document.getElementById(id);
      if (el) el.classList.toggle('open');
    }

    function renderWebhooks(webhooks) {
      if (!webhooks || webhooks.length === 0) return '<span style="color:#666">-</span>';
      return webhooks.map((wh) => {
        const isOk = wh.responseStatus >= 200 && wh.responseStatus < 300;
        return '<div class="webhook-entry">' +
          '<span class="wh-status ' + (isOk ? 'wh-ok' : 'wh-fail') + '">' +
            wh.payload.Status + '</span> ' +
          '&rarr; ' + wh.responseStatus +
          ' <span class="time">' + formatTime(wh.sentAt) + '</span>' +
        '</div>';
      }).join('');
    }

    let counter = 0;

    async function fetchPayments() {
      try {
        const res = await fetch('api/payments');
        const data = await res.json();
        document.getElementById('total').textContent = data.total;

        if (data.payments.length === 0) {
          document.getElementById('tbody').innerHTML =
            '<tr><td colspan="8" class="empty">No payments yet</td></tr>';
          return;
        }

        document.getElementById('tbody').innerHTML = data.payments.map((p) => {
          const pid = 'payload-' + p.paymentId;
          return '<tr>' +
            '<td class="time">' + formatTime(p.createdAt) + '</td>' +
            '<td class="order-id">#' + escapeHtml(String(p.orderId)) + '</td>' +
            '<td>' + p.paymentId + '</td>' +
            '<td class="amount">' + formatAmount(p.amount) + '</td>' +
            '<td class="desc" title="' + escapeHtml(p.description) + '">' + escapeHtml(p.description) + '</td>' +
            '<td><span class="status status-' + p.status + '">' + p.status + '</span></td>' +
            '<td>' +
              '<span class="payload-toggle" onclick="togglePayload(\'' + pid + '\')">Show payload</span>' +
              '<div class="payload-content" id="' + pid + '">' + escapeHtml(JSON.stringify(p.requestPayload, null, 2)) + '</div>' +
            '</td>' +
            '<td>' + renderWebhooks(p.webhooks) + '</td>' +
          '</tr>';
        }).join('');
      } catch (err) {
        console.error('Fetch failed:', err);
      }
    }

    fetchPayments();
    setInterval(fetchPayments, 5000);
  </script>
</body>
</html>
